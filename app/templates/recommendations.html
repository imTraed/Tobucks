{% extends 'base.html' %}

{% block title %}Para Ti - Tobucks{% endblock %}

{% block head %}
<style>
  /* --- ESTILOS BASE --- */
  body {
      background-color: #000000;
      color: #f5f5f7;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
  }

  /* --- HEADER (Compacto) --- */
.rec-header {
    text-align: center;
    padding: 20px 20px 10px; /* Reducido porque ya tenemos padding en body */
    background: radial-gradient(circle at center top, rgba(255, 215, 0, 0.15), transparent 70%);
    margin-bottom: 10px; 
}

/* Versión Móvil */
@media (max-width: 768px) {
    .rec-header {
        /* NUEVO: Padding superior grande para librar el logo "TOBUCKS" */
        padding-top: 100px; 
        text-align: left;
        margin-bottom: 15px;
    }
}

  .rec-subtitle-badge {
      display: inline-block;
      font-size: 0.7rem;
      font-weight: 800;
      letter-spacing: 2px;
      color: #FFD700;
      text-transform: uppercase;
      margin-bottom: 8px;
      padding: 4px 10px;
      border: 1px solid rgba(255, 215, 0, 0.3);
      border-radius: 20px;
      background: rgba(255, 215, 0, 0.05);
  }

  .rec-title {
      font-size: 2.8rem;
      font-weight: 900;
      color: #fff;
      margin: 0;
      letter-spacing: -1px;
      line-height: 1.1;
  }

  .rec-desc-main {
      color: #8e8e93;
      margin-top: 8px;
      font-size: 0.95rem;
      max-width: 500px;
      margin-left: auto;
      margin-right: auto;
      margin-bottom: 0; 
  }

  /* --- CONTENEDOR LISTA --- */
  .rec-container {
      max-width: 800px;
      margin: 0 auto;
      padding: 0 20px 100px;
  }

  /* --- TARJETA RECOMENDACIÓN --- */
  .rec-card {
      display: flex;
      background: #1c1c1e;
      border: 1px solid rgba(255, 255, 255, 0.08);
      border-radius: 16px;
      overflow: hidden;
      margin-bottom: 15px; 
      text-decoration: none;
      transition: transform 0.3s cubic-bezier(0.25, 0.8, 0.25, 1), box-shadow 0.3s;
      position: relative;
  }

  .rec-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 30px rgba(0,0,0,0.5);
      border-color: rgba(255, 215, 0, 0.3);
  }

  .rec-poster-col {
      width: 130px;
      flex-shrink: 0;
      position: relative;
  }

  .rec-poster {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
  }

  .rec-info-col {
      padding: 20px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      flex-grow: 1;
      min-width: 0;
  }

  .rec-movie-title {
      font-size: 1.3rem;
      font-weight: 800;
      color: #fff;
      margin-bottom: 5px;
      line-height: 1.2;
  }

  .rec-meta-row {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 12px;
      font-size: 0.85rem;
  }

  .rec-genre {
      color: #FFD700;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
  }

  .rec-synopsis {
      color: #a1a1a6;
      font-size: 0.95rem;
      line-height: 1.5;
      display: -webkit-box;
      -webkit-line-clamp: 3;
      -webkit-box-orient: vertical;
      overflow: hidden;
  }

  .rec-poster-placeholder {
      width: 100%; height: 100%;
      background: #2c2c2e;
      display: flex; align-items: center; justify-content: center;
      color: rgba(255,255,255,0.1); font-size: 2rem;
  }

  .loading-indicator {
      text-align: center;
      padding: 40px;
      display: none;
  }
  .spinner-border { width: 2.5rem; height: 2.5rem; color: #FFD700; }

  /* =========================================
     OPTIMIZACIÓN MÓVIL
     ========================================= */
  @media (max-width: 768px) {
      .rec-header {
          padding: 30px 15px 5px; 
          text-align: left;
          margin-bottom: 15px;
      }
      .rec-title { font-size: 2.2rem; }
      
      .rec-container {
          padding: 0 15px 100px;
      }

      .rec-card {
          border-radius: 12px;
          margin-bottom: 12px;
          height: 150px; 
      }

      .rec-poster-col { width: 105px; }

      .rec-info-col { padding: 12px; }

      .rec-movie-title {
          font-size: 1rem;
          margin-bottom: 4px;
          white-space: nowrap; 
          overflow: hidden; 
          text-overflow: ellipsis; 
      }

      .rec-synopsis {
          font-size: 0.8rem;
          -webkit-line-clamp: 3;
          line-height: 1.4;
      }
      
      .rec-meta-row {
          margin-bottom: 6px;
          gap: 6px;
      }
  }
</style>
{% endblock %}

{% block content %}

<div class="rec-header">
    <div class="rec-subtitle-badge">Tus Preferencias</div>
    <h1 class="rec-title">Para Ti</h1>
    <p class="rec-desc-main">Películas seleccionadas basadas en tus gustos.</p>
</div>

<div class="rec-container">
    
    {% if recommendations %}
    <div id="recommendationsList">
      {% for movie in recommendations %}
      <a href="{{ url_for('movies.view_movie', movie_id=movie.id) }}" class="rec-card">
          
          <div class="rec-poster-col">
              {% if movie.poster %}
                  <img src="{{ url_for('static', filename=movie.poster) }}" class="rec-poster" alt="{{ movie.title }}" loading="lazy">
              {% else %}
                  <div class="rec-poster-placeholder"><i class="bi bi-film"></i></div>
              {% endif %}
          </div>
          
          <div class="rec-info-col">
              <div class="rec-meta-row">
                  {% if movie.genres %}
                      <span class="rec-genre">{{ movie.genres[0].name }}</span>
                  {% endif %}
              </div>
              
              <h3 class="rec-movie-title">{{ movie.title }}</h3>
              
              <p class="rec-synopsis">{{ movie.description }}</p>
          </div>

      </a>
      {% endfor %}
      
      <div class="loading-indicator" id="loadingIndicator">
          <div class="spinner-border" role="status">
              <span class="visually-hidden">Cargando...</span>
          </div>
      </div>
    </div>

    {% else %}
      <div class="alert alert-dark border-secondary border-opacity-25 py-5 text-center rounded-3 mt-4" style="background: #1c1c1e;">
         <i class="bi bi-sliders display-1 text-warning mb-3 d-block opacity-50"></i>
         <h4 class="text-white">Sin preferencias definidas</h4>
         <p class="text-white-50 px-3">Selecciona tus géneros favoritos para ver recomendaciones aquí.</p>
         <a href="{{ url_for('users.preferences') }}" class="btn btn-outline-warning mt-3 rounded-pill px-4">Configurar Gustos</a>
      </div>
    {% endif %}
    
</div>

<script type="text/javascript">
    document.addEventListener("DOMContentLoaded", function() {
        const loadingIndicator = document.getElementById('loadingIndicator');
        let page = 2; 
        let isLoading = false;
        let hasMore = true; 

        window.addEventListener('scroll', () => {
            if ((window.innerHeight + window.scrollY) >= document.body.offsetHeight - 500) {
                if (!isLoading && hasMore) {
                    loadMoreMovies();
                }
            }
        });

        async function loadMoreMovies() {
            isLoading = true;
            if(loadingIndicator) loadingIndicator.style.display = 'block';

            try {
                const response = await fetch(`{{ url_for('recommendations.recommendations') }}?page=${page}&json=true`);
                
                if (response.ok) {
                    const data = await response.json();
                    
                    if (data.movies && data.movies.length > 0) {
                        data.movies.forEach(movie => {
                            const cardHTML = createMovieCard(movie);
                            loadingIndicator.insertAdjacentHTML('beforebegin', cardHTML);
                        });
                        page++;
                    } else {
                        hasMore = false; 
                    }
                } else {
                    hasMore = false; 
                }
            } catch (error) {
                console.error("Error:", error);
                hasMore = false;
            } finally {
                isLoading = false;
                if(loadingIndicator) loadingIndicator.style.display = 'none';
            }
        }

        function createMovieCard(movie) {
            const staticBaseUrl = "{{ url_for('static', filename='') }}";
            const posterSrc = movie.poster ? `${staticBaseUrl}${movie.poster}` : '';
            
            const posterDiv = movie.poster 
                ? `<img src="${posterSrc}" class="rec-poster" alt="${movie.title}" loading="lazy">`
                : `<div class="rec-poster-placeholder"><i class="bi bi-film"></i></div>`;
            
            const genreName = (movie.genres && movie.genres.length > 0) ? movie.genres[0].name : 'General';

            return `
            <a href="/movies/view/${movie.id}" class="rec-card">
                <div class="rec-poster-col">
                    ${posterDiv}
                </div>
                <div class="rec-info-col">
                    <div class="rec-meta-row">
                        <span class="rec-genre">${genreName}</span>
                    </div>
                    <h3 class="rec-movie-title">${movie.title}</h3>
                    <p class="rec-synopsis">${movie.description || ''}</p>
                </div>
            </a>
            `;
        }
    });
</script>
{% endblock %}