{% extends 'base.html' %}

{% block title %}Modo Aventura - Tobucks{% endblock %}

{% block head %}
<style>
    /* --- ESTILOS GENERALES Y JUEGO --- */
    body {
        background: radial-gradient(ellipse at center, #141414 0%, #000000 100%);
        overflow-x: hidden;
    }

    .adventure-wrapper {
        min-height: 85vh;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 20px;
    }

    /* BARRA PROGRESO */
    .progress-container {
        width: 100%; max-width: 600px; height: 6px;
        background: rgba(255,255,255,0.1); border-radius: 10px; margin-bottom: 50px;
    }
    .progress-bar-fill {
        height: 100%; background: #FFD700; width: 0%; transition: width 0.4s ease-out;
        box-shadow: 0 0 15px #FFD700;
    }

    /* PREGUNTAS */
    .question-card { text-align: center; max-width: 1000px; animation: slideUp 0.5s ease-out; width: 100%; }
    
    /* Ajuste: Quitamos el margen inferior excesivo ya que no hay contador */
    .question-text { 
        font-size: 2.5rem; 
        font-weight: 900; 
        color: #fff; 
        margin-bottom: 2.5rem; 
        text-shadow: 0 4px 10px rgba(0,0,0,0.5); 
        line-height: 1.2; 
    }
    .question-text span { color: #FFD700; }

    .options-grid {
        display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin-top: 30px;
    }
    @media (min-width: 992px) { .options-grid.grid-4 { grid-template-columns: repeat(4, 1fr); } }
    @media (max-width: 768px) { .options-grid { grid-template-columns: 1fr; } }

    .option-btn {
        background: rgba(255, 255, 255, 0.03); border: 1px solid rgba(255, 255, 255, 0.1);
        padding: 25px; border-radius: 16px; color: #eee; cursor: pointer;
        display: flex; align-items: center; gap: 20px; transition: all 0.2s;
        backdrop-filter: blur(5px);
        text-align: left;
    }
    .option-btn:hover {
        background: rgba(255, 215, 0, 0.1); border-color: #FFD700; transform: translateY(-3px);
        color: white;
        box-shadow: 0 5px 15px rgba(255, 215, 0, 0.15);
    }
    .option-icon { font-size: 1.8rem; color: #FFD700; flex-shrink: 0; }
    .option-title { font-weight: 800; font-size: 1.1rem; display: block; margin-bottom: 4px; }
    .option-desc { font-size: 0.85rem; opacity: 0.6; line-height: 1.3; }

    /* LOADER */
    .loader-area { display: none; text-align: center; }
    .spinner-grow { width: 4rem; height: 4rem; }

    /* --- ESTILOS DE RESULTADOS (DASHBOARD) --- */
    #resultsBox { display: none; width: 100%; animation: fadeIn 0.8s; }

    .full-screen-dashboard {
        height: 80vh; 
        display: flex;
        gap: 30px;
        width: 100%;
        max-width: 1600px;
        margin: 0 auto;
    }
    @media (max-width: 992px) {
        .full-screen-dashboard { flex-direction: column; height: auto; }
    }

    /* COLUMNA IZQUIERDA */
    .main-results-column {
        flex: 2;
        display: flex;
        flex-direction: column;
    }
    
    .cards-row-stretch {
        display: flex;
        gap: 20px;
        flex-grow: 1;
        align-items: flex-start; 
        height: 100%;
    }
    @media (max-width: 768px) { .cards-row-stretch { flex-direction: column; } }

    .ai-result-card {
        flex: 1;
        display: flex;
        flex-direction: column;
        height: 100%;
        background: linear-gradient(145deg, #1a1a1a 0%, #0f0f0f 100%);
        border: 1px solid rgba(255, 215, 0, 0.15);
        border-radius: 12px;
        overflow: hidden;
        transition: all 0.4s;
        text-decoration: none;
    }
    .ai-result-card:hover {
        border-color: #FFD700;
        transform: translateY(-8px);
        box-shadow: 0 15px 40px rgba(0,0,0,0.6);
    }

    /* PORTADAS TOP 3 */
    .top-poster-container {
        position: relative;
        width: 100%;
        height: 220px; 
        overflow: hidden;
        background-color: #000;
        border-bottom: 1px solid rgba(255,255,255,0.1);
    }
    .top-poster-img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        object-position: top center;
        opacity: 0.9;
        transition: transform 0.5s ease, opacity 0.5s ease;
    }
    .ai-result-card:hover .top-poster-img {
        transform: scale(1.05);
        opacity: 1;
    }

    /* COLUMNA DERECHA */
    .sidebar-column {
        flex: 1;
        display: flex;
        flex-direction: column;
        background: rgba(255, 255, 255, 0.03);
        border-radius: 16px;
        padding: 20px;
        border: 1px solid rgba(255, 255, 255, 0.05);
        min-width: 320px;
    }

    .mentions-scroll-area {
        flex-grow: 1;
        overflow-y: auto;
        padding-right: 10px;
        margin-bottom: 20px;
    }
    .mentions-scroll-area::-webkit-scrollbar { width: 5px; }
    .mentions-scroll-area::-webkit-scrollbar-track { background: rgba(255,255,255,0.05); border-radius: 10px; }
    .mentions-scroll-area::-webkit-scrollbar-thumb { background: #FFD700; border-radius: 10px; }

    .mention-card-small {
        display: flex;
        align-items: center;
        gap: 12px;
        background: rgba(0,0,0,0.3);
        padding: 10px;
        border-radius: 10px;
        border: 1px solid rgba(255,255,255,0.05);
        text-decoration: none;
        transition: all 0.2s;
        margin-bottom: 10px;
    }
    .mention-card-small:hover {
        background: rgba(255,215,0,0.1);
        border-color: rgba(255,215,0,0.3);
        transform: translateX(5px);
    }
    .mention-poster-small { width: 50px; height: 75px; object-fit: cover; border-radius: 6px; }
    .mention-placeholder-small { width: 50px; height: 75px; background: #222; border-radius: 6px; display: flex; align-items: center; justify-content: center; color: #555; }

    .btn-mega-cta {
        width: 100%; padding: 15px;
        font-size: 1.1rem; font-weight: 900; text-transform: uppercase; letter-spacing: 2px;
        border-radius: 12px;
        background: linear-gradient(135deg, #FFD700 0%, #FFC700 100%);
        color: #000; border: none; cursor: pointer;
        box-shadow: 0 10px 30px rgba(255, 215, 0, 0.3);
        animation: pulse-gold 2s infinite;
        display: flex; align-items: center; justify-content: center; gap: 10px;
    }
    .btn-mega-cta:hover { transform: scale(1.03); box-shadow: 0 15px 50px rgba(255, 215, 0, 0.5); color: #000; }

    @keyframes pulse-gold {
        0% { box-shadow: 0 0 0 0 rgba(255, 215, 0, 0.7); }
        70% { box-shadow: 0 0 0 15px rgba(255, 215, 0, 0); }
        100% { box-shadow: 0 0 0 0 rgba(255, 215, 0, 0); }
    }
    @keyframes slideUp { from { opacity: 0; transform: translateY(50px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid p-0">
    <div class="adventure-wrapper">

        <div class="progress-container" id="progressBox">
            <div class="progress-bar-fill" id="progressBar"></div>
        </div>

        <div id="gameBox" class="question-card"></div>

        <div id="loaderBox" class="loader-area">
            <div class="spinner-grow text-warning mb-4" role="status"></div>
            <h2 class="text-white fw-bold">La IA está pensando...</h2>
            <p class="text-white-50">Analizando tus respuestas para encontrar la joya oculta.</p>
        </div>

        <div id="resultsBox">
            <div class="full-screen-dashboard">
                
                <div class="main-results-column">
                    <div class="mb-3 text-center text-md-start">
                        <h5 class="text-secondary text-uppercase fw-bold mb-1 ls-2 small">
                            <i class="bi bi-stars text-warning me-2"></i>Resultados Personalizados
                        </h5>
                        <h1 class="display-6 fw-bolder text-white m-0">Tu Selección Perfecta</h1>
                    </div>

                    <div id="topPicksRow" class="cards-row-stretch"></div>
                </div>

                <div class="sidebar-column">
                    <h5 class="text-white fw-bold mb-4 d-flex align-items-center">
                        <i class="bi bi-patch-plus-fill text-warning me-2 fs-4"></i> Alternativas
                    </h5>
                    
                    <div id="mentionsList" class="mentions-scroll-area"></div>
                    
                    <div style="margin-top: auto;">
                        <button onclick="resetGame()" class="btn-mega-cta">
                                <i class="bi bi-controller fs-4"></i>
                                <span>Jugar de nuevo</span>
                        </button>
                    </div>
                </div>

            </div>
        </div>

    </div>
</div>

<script>
    // --- SCRIPT ACTUALIZADO SIN CONTADORES Y CON TIEMPO ---
    const script = [
        {
            // PREGUNTA 1: TIEMPO (NUEVA PRIORIDAD)
            text: "¿De cuánto <span>tiempo</span> dispones hoy?",
            options: [
                { title: "Algo Rápido", desc: "Menos de 90 minutos (Flash).", icon: "bi-stopwatch", val: "duración: corta (menos de 90 min)" },
                { title: "Estándar", desc: "Unas 2 horas (Lo normal).", icon: "bi-clock", val: "duración: estándar (alrededor de 2h)" },
                { title: "Épico", desc: "Más de 2.5 horas (Sin prisa).", icon: "bi-hourglass-split", val: "duración: larga/épica" },
                { title: "Tengo todo el día", desc: "Maratón o lo que sea.", icon: "bi-infinity", val: "duración: indiferente" }
            ]
        },
        {
            // PREGUNTA 2: ENERGÍA
            text: "¿Cómo está tu <span>nivel de energía</span>?",
            options: [
                { title: "Batería Baja", desc: "Quiero algo suave, reconfortante, 'feel-good'.", icon: "bi-cup-hot", val: "energía: baja/relax" },
                { title: "Modo Fiesta", desc: "Quiero reírme, ruido, algo divertido.", icon: "bi-emoji-sunglasses", val: "energía: alta/diversión" },
                { title: "Intenso", desc: "Quiero tensión, adrenalina o miedo.", icon: "bi-lightning-charge", val: "energía: intensa/adrenalina" },
                { title: "Curioso", desc: "Quiero que me vuelen la cabeza o aprender algo.", icon: "bi-lightbulb", val: "energía: curiosa/intelectual" }
            ]
        },
        {
            // PREGUNTA 3: COMPLEJIDAD
            text: "¿Cuánto quieres <span>pensar</span> durante la película?",
            options: [
                { title: "Cero", desc: "Entretenimiento puro, apagar el cerebro.", icon: "bi-tv", val: "complejidad: baja/entretenimiento puro" },
                { title: "Lo Normal", desc: "Una buena historia pero fácil de seguir.", icon: "bi-book", val: "complejidad: media/narrativa estándar" },
                { title: "Reto Mental", desc: "Tramas complejas, giros, misterios.", icon: "bi-puzzle", val: "complejidad: alta/thriller psicológico" },
                { title: "Filosófico", desc: "Cine de arte, lento, profundo.", icon: "bi-chat-quote", val: "complejidad: muy alta/cine de arte" }
            ]
        },
        {
            // PREGUNTA 4: ESCENARIO
            text: "Elige el <span>escenario</span> ideal para hoy:",
            options: [
                { title: "Mundo Real", desc: "Drama humano, crimen urbano, historia real.", icon: "bi-building", val: "escenario: realista/urbano" },
                { title: "Fantasía/Magia", desc: "Dragones, espadas, mundos imposibles.", icon: "bi-magic", val: "escenario: fantasía épica" },
                { title: "Futuro/Espacio", desc: "Naves, robots, distopías tecnológicas.", icon: "bi-rocket", val: "escenario: ciencia ficción/futuro" },
                { title: "Pasado/Época", desc: "Vestidos antiguos, guerras, nostalgia.", icon: "bi-compass", val: "escenario: histórico/época" }
            ]
        },
        {
            // PREGUNTA 5: PROTAGONISTA
            text: "¿Qué tipo de <span>protagonista</span> quieres seguir?",
            options: [
                { title: "El Héroe", desc: "Noble, valiente, el clásico 'chico bueno'.", icon: "bi-shield-check", val: "protagonista: héroe clásico" },
                { title: "El Antihéroe", desc: "Moralmente gris, cínico, rompe las reglas.", icon: "bi-incognito", val: "protagonista: antihéroe" },
                { title: "El Perdedor", desc: "Alguien común enfrentando algo enorme.", icon: "bi-person-walking", val: "protagonista: underdog/persona común" },
                { title: "El Villano", desc: "Una historia desde la perspectiva del malo.", icon: "bi-emoji-angry", val: "protagonista: villano/perspectiva oscura" }
            ]
        },
        {
            // PREGUNTA 6: ÉPOCA
            text: "¿Qué década te llama la atención?",
            options: [
                { title: "Lo Nuevo", desc: "Cine moderno (2010 - Actualidad).", icon: "bi-phone", val: "época: contemporánea/moderna" },
                { title: "Nostalgia 90s/00s", desc: "La era dorada del DVD y Blockbuster.", icon: "bi-disc", val: "época: 1990-2010" },
                { title: "Clásicos 80s", desc: "Cine de culto, neón y sintetizadores.", icon: "bi-boombox", val: "época: años 80" },
                { title: "Sin Tiempo", desc: "Me da igual el año si es buena.", icon: "bi-calendar-check", val: "época: cualquiera (calidad atemporal)" }
            ]
        },
        {
            // PREGUNTA 7: FINAL
            text: "¿Qué sensación quieres al <span>final</span>?",
            options: [
                { title: "Esperanza", desc: "Un final feliz que te deje sonriendo.", icon: "bi-heart-fill", val: "final: feliz/esperanzador" },
                { title: "Shock", desc: "Un giro de tuerca que no veas venir.", icon: "bi-exclamation-triangle", val: "final: plot twist/sorpresivo" },
                { title: "Melancolía", desc: "Un final agridulce o trágico para llorar.", icon: "bi-cloud-rain", val: "final: triste/emotivo" },
                { title: "Ambigüedad", desc: "Un final abierto para quedarte pensando.", icon: "bi-question-circle", val: "final: abierto/ambiguo" }
            ]
        }
    ];

    let step = 0, story = [];

    document.addEventListener("DOMContentLoaded", () => {
        const savedResults = sessionStorage.getItem('tobucks_ai_results');
        if (savedResults) {
            try {
                const data = JSON.parse(savedResults);
                document.getElementById('gameBox').style.display = 'none';
                document.getElementById('progressBox').style.display = 'none';
                renderResults(data);
            } catch (e) {
                renderStep(0);
            }
        } else {
            renderStep(0);
        }
    });

    function renderStep(idx) {
        const box = document.getElementById('gameBox');
        const data = script[idx];
        document.getElementById('progressBar').style.width = `${((idx)/script.length)*100}%`;

        // Renderizado SIN el texto "Pregunta X/7"
        let html = `<div class="question-text">${data.text}</div><div class="options-grid grid-4">`;
        data.options.forEach(opt => {
            html += `
                <div class="option-btn" onclick="nextStep('${opt.val}')">
                    <i class="bi ${opt.icon} option-icon"></i>
                    <div><span class="option-title">${opt.title}</span><span class="option-desc">${opt.desc}</span></div>
                </div>`;
        });
        html += `</div>`;
        box.innerHTML = html;
    }

    function nextStep(val) {
        story.push(val);
        step++;
        step < script.length ? renderStep(step) : finishGame();
    }

    async function finishGame() {
        document.getElementById('gameBox').style.display = 'none';
        document.getElementById('progressBox').style.display = 'none';
        document.getElementById('loaderBox').style.display = 'block';

        try {
            const res = await fetch("{{ url_for('ai.ask_adventure') }}", {
                method: "POST",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify({ narrative: story.join(". ") })
            });
            const data = await res.json();
            document.getElementById('loaderBox').style.display = 'none';
            
            if (data.error) { 
                alert(data.error); 
                location.reload(); 
            } else { 
                sessionStorage.setItem('tobucks_ai_results', JSON.stringify(data));
                renderResults(data); 
            }
        } catch (e) { alert("Error de conexión con el servidor IA."); }
    }

    function resetGame() {
        sessionStorage.removeItem('tobucks_ai_results');
        location.reload();
    }

    function renderResults(data) {
        document.getElementById('resultsBox').style.display = 'block';
        const topContainer = document.getElementById('topPicksRow');
        const mentionsContainer = document.getElementById('mentionsList');
        
        // 1. TOP PICKS
        let htmlTop = '';
        const tops = data.top_picks || [];
        
        tops.forEach((movie, index) => {
            const posterSrc = movie.poster ? `{{ url_for('static', filename='') }}${movie.poster}` : null;
            const imgContent = posterSrc 
                ? `<img src="${posterSrc}" class="top-poster-img" alt="${movie.title}">`
                : `<div class="d-flex align-items-center justify-content-center h-100 w-100 bg-dark"><i class="bi bi-film display-3 text-secondary opacity-25"></i></div>`;

            const posterContainer = `
                <div class="top-poster-container">
                    ${imgContent}
                    <div class="position-absolute top-0 start-0 p-3" style="z-index: 2;">
                        <span class="badge bg-warning text-dark fw-bold fs-6 shadow-sm">#${index + 1} TOP</span>
                    </div>
                </div>`;
            
            const link = movie.id ? `/movies/view/${movie.id}` : '#';
            const btnClass = movie.id ? 'btn-outline-warning' : 'btn-dark disabled text-white-50';
            const btnText = movie.id ? 'Detalles <i class="bi bi-arrow-right ms-2"></i>' : 'No disponible';

            htmlTop += `
            <a href="${link}" class="ai-result-card">
                ${posterContainer}
                <div class="card-body text-white d-flex flex-column p-4">
                    <h4 class="card-title fw-bolder mb-2" style="color: #FFD700; font-size: 1.1rem; line-height: 1.3;">${movie.title}</h4>
                    <div class="mb-3">
                        ${movie.genres.map(g => `<span class="badge bg-dark border border-secondary text-white-50 me-1 mb-1" style="font-size:0.65rem;">${g}</span>`).join('')}
                    </div>
                    <p class="card-text fst-italic opacity-75 mb-3 flex-grow-1" style="font-size: 0.85rem; line-height: 1.5;">
                        <i class="bi bi-quote fs-5 text-warning me-1 opacity-50"></i>
                        ${movie.reason}
                    </p>
                    <div class="btn ${btnClass} w-100 fw-bold rounded-pill mt-auto btn-sm py-2">
                        ${btnText}
                    </div>
                </div>
            </a>`;
        });
        topContainer.innerHTML = htmlTop;

        // 2. MENCIONES
        let htmlMentions = '';
        const extras = data.also_like || [];
        
        if (extras.length > 0) {
            extras.forEach(extra => {
                const poster = extra.poster ? `{{ url_for('static', filename='') }}${extra.poster}` : null;
                const posterDiv = poster 
                    ? `<img src="${poster}" class="mention-poster-small" alt="${extra.title}">`
                    : `<div class="mention-placeholder-small"><i class="bi bi-film"></i></div>`;
                
                htmlMentions += `
                <a href="/movies/view/${extra.id}" class="mention-card-small">
                    ${posterDiv}
                    <div class="text-white fw-bold text-truncate" style="font-size: 0.9rem;">${extra.title}</div>
                </a>`;
            });
        } else {
            htmlMentions = '<div class="text-white-50 small text-center mt-3">No hay menciones extra.</div>';
        }
        mentionsContainer.innerHTML = htmlMentions;
    }
</script>
{% endblock %}