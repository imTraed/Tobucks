{% extends 'base.html' %}

{% block title %}Mis Gustos - Tobucks{% endblock %}

{% block head %}
<style>
    /* --- BASE --- */
    body { 
        background-color: #000; 
        color: #fff; 
        padding-bottom: 220px !important; 
    }

    /* --- HEADER (TÍTULO) --- */
    .pref-header {
        text-align: center; 
        padding: 60px 20px 20px; 
        background: radial-gradient(circle at center top, rgba(255, 215, 0, 0.1), transparent 70%);
        max-width: 800px;
        margin: 0 auto;
    }
    
    .pref-title { 
        font-size: 2.5rem; 
        font-weight: 800; 
        margin-bottom: 10px; 
        color: #fff; 
        letter-spacing: -1px;
    }
    
    .pref-desc { 
        color: #8e8e93; 
        font-size: 1rem; 
        max-width: 500px; 
        margin: 0 auto; 
    }

    /* --- GRID DE GÉNEROS --- */
    .genres-grid {
        display: grid; 
        grid-template-columns: repeat(2, 1fr); 
        gap: 15px;
        padding: 20px; 
        max-width: 1000px; 
        margin: 0 auto;
    }

    @media (min-width: 768px) {
        .genres-grid {
            grid-template-columns: repeat(4, 1fr); 
        }
    }

    /* --- CORRECCIONES MÓVIL --- */
    @media (max-width: 991px) {
        .pref-header {
            padding-top: 25px; 
            padding-bottom: 10px;
        }
        .pref-title {
            font-size: 2rem;
        }

        /* AJUSTE BOTÓN FLOTANTE MÓVIL */
        .save-bar-container {
            bottom: 110px !important; 
            padding-bottom: 0 !important;
            background: transparent !important; 
        }
        
        .btn-save-float {
            width: 90% !important; 
            box-shadow: none !important; /* SIN SOMBRA EN MÓVIL */
        }
    }

    /* --- TARJETA DE GÉNERO --- */
    .genre-checkbox { position: absolute; opacity: 0; cursor: pointer; height: 0; width: 0; }
    
    .genre-card {
        position: relative; 
        background: #1c1c1e; 
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 16px; 
        padding: 25px 10px; 
        text-align: center;
        cursor: pointer; 
        transition: all 0.2s cubic-bezier(0.25, 0.8, 0.25, 1); 
        min-height: 120px;
        display: flex; 
        flex-direction: column; 
        align-items: center; 
        justify-content: center;
    }

    .genre-icon { 
        font-size: 2rem; 
        color: #555; 
        margin-bottom: 12px; 
        transition: color 0.2s, transform 0.2s; 
    }
    
    .genre-name { 
        font-weight: 600; 
        font-size: 0.95rem; 
        color: #aaa; 
        text-transform: capitalize; 
    }

    /* --- ESTADO SELECCIONADO --- */
    .genre-checkbox:checked + .genre-card {
        background: rgba(255, 215, 0, 0.15); 
        border-color: #FFD700; 
        transform: translateY(-3px);
        /* Mantenemos una sombra sutil SOLO en las tarjetas seleccionadas, no en el botón */
        box-shadow: 0 10px 20px rgba(0,0,0,0.3);
    }
    .genre-checkbox:checked + .genre-card .genre-icon { 
        color: #FFD700; 
        transform: scale(1.1); 
    }
    .genre-checkbox:checked + .genre-card .genre-name { 
        color: #fff; 
        font-weight: 800; 
    }
    
    .check-indicator {
        position: absolute; top: 10px; right: 10px; width: 22px; height: 22px;
        background: #FFD700; border-radius: 50%; display: flex; align-items: center; 
        justify-content: center; font-size: 14px; color: #000; opacity: 0; transform: scale(0); transition: all 0.2s;
    }
    .genre-checkbox:checked + .genre-card .check-indicator { opacity: 1; transform: scale(1); }

    /* --- BOTÓN BORRAR (ADMIN) --- */
    .btn-delete-genre {
        position: absolute; top: 5px; left: 5px; width: 30px; height: 30px;
        background: rgba(220, 53, 69, 0.2); color: #dc3545; border: 1px solid rgba(220, 53, 69, 0.5);
        border-radius: 50%; display: flex; align-items: center; justify-content: center;
        font-size: 14px; z-index: 10; transition: all 0.2s; cursor: pointer;
    }
    .btn-delete-genre:hover { background: #dc3545; color: white; transform: scale(1.1); }

    /* --- FOOTER FLOTANTE (BOTÓN GUARDAR) --- */
    .save-bar-container {
        position: fixed; 
        bottom: 30px; 
        left: 0; right: 0; z-index: 1020; 
        display: flex; justify-content: center;
        padding: 0 20px 20px;
        background: transparent; /* Fondo transparente */
        pointer-events: none;
    }
    
    .btn-save-float {
        pointer-events: auto; width: 100%; max-width: 500px;
        background: linear-gradient(135deg, #FFD700, #FFA500); color: #000;
        font-weight: 800; border: none; padding: 16px; border-radius: 50px;
        font-size: 1.1rem;
        
        /* SIN SOMBRA AQUÍ TAMBIÉN */
        box-shadow: none !important; 
        
        text-transform: uppercase; display: flex; align-items: center; justify-content: center; gap: 10px;
        transition: transform 0.2s;
    }
    .btn-save-float:active { transform: scale(0.96); }
    
    #savingIndicator {
        position: fixed; top: 120px; left: 50%; transform: translateX(-50%);
        padding: 10px 25px; border-radius: 30px; font-weight: 700; font-size: 0.9rem;
        z-index: 2000; display: none; box-shadow: 0 5px 20px rgba(0,0,0,0.5);
    }
</style>
{% endblock %}

{% block content %}

<div class="pref-header">
    <h1 class="pref-title">Mis Gustos</h1>
    <p class="pref-desc">Selecciona tus favoritos y nuestra IA te recomendará películas personalizadas.</p>
</div>

<form id="preferencesForm">
    <div class="genres-grid">
        {% for genre in genres %}
            <div style="position: relative;">
                
                {% if current_user.is_admin %}
                <button type="button" class="btn-delete-genre" onclick="deleteGenre(event, '{{ genre.id }}', '{{ genre.name }}')">
                    <i class="bi bi-trash3-fill"></i>
                </button>
                {% endif %}

                <label style="width: 100%; display: block; margin: 0;">
                    <input type="checkbox" name="genres" value="{{ genre.id }}" class="genre-checkbox"
                        {% if user_genre_ids and genre.id in user_genre_ids %}checked{% endif %}>
                    
                    <div class="genre-card">
                        <div class="check-indicator"><i class="bi bi-check-lg"></i></div>
                        <i class="bi bi-film genre-icon" data-genre="{{ genre.name }}"></i>
                        <span class="genre-name">{{ genre.name }}</span>
                    </div>
                </label>
            </div>
        {% endfor %}
    </div>
</form>

<div id="savingIndicator"></div>

<div class="save-bar-container">
    <button type="button" class="btn-save-float" onclick="savePreferences()">
        <i class="bi bi-save2-fill"></i> GUARDAR GUSTOS
    </button>
</div>

<script>
    // ICONOS AUTOMÁTICOS
    document.addEventListener("DOMContentLoaded", () => {
        const iconsMap = {
            'acción': 'bi-fire', 'action': 'bi-fire',
            'aventura': 'bi-compass-fill', 'adventure': 'bi-compass-fill',
            'comedia': 'bi-emoji-laughing-fill', 'comedy': 'bi-emoji-laughing-fill',
            'drama': 'bi-suit-spade-fill',
            'terror': 'bi-emoji-astonished-fill', 'horror': 'bi-emoji-astonished-fill',
            'romance': 'bi-heart-fill',
            'ciencia': 'bi-rocket-takeoff-fill', 'sci-fi': 'bi-rocket-takeoff-fill',
            'fantasía': 'bi-stars', 'fantasy': 'bi-stars',
            'animación': 'bi-magic', 'animation': 'bi-magic',
            'crimen': 'bi-fingerprint', 'crime': 'bi-fingerprint',
            'misterio': 'bi-search', 'mystery': 'bi-search',
            'thriller': 'bi-eye-fill', 'suspense': 'bi-eye-fill', 'suspenso': 'bi-eye-fill',
            'documental': 'bi-camera-reels-fill', 'documentary': 'bi-camera-reels-fill',
            'historia': 'bi-bank', 'history': 'bi-bank',
            'guerra': 'bi-shield-shaded', 'war': 'bi-shield-shaded',
            'música': 'bi-music-note-beamed', 'music': 'bi-music-note-beamed',
            'familia': 'bi-house-heart-fill', 'family': 'bi-house-heart-fill',
            'biografía': 'bi-person-vcard-fill', 'biography': 'bi-person-vcard-fill',
            'western': 'bi-brightness-high-fill'
        };

        document.querySelectorAll('.genre-icon').forEach(icon => {
            const name = icon.getAttribute('data-genre').toLowerCase();
            let found = false;
            for (const [key, val] of Object.entries(iconsMap)) {
                if (name.includes(key)) {
                    icon.className = `bi ${val} genre-icon`;
                    found = true; break;
                }
            }
            if (!found) icon.className = `bi bi-film genre-icon`;
        });
    });

    // GUARDAR (AJAX)
    function savePreferences() {
        const checkboxes = document.querySelectorAll('.genre-checkbox:checked');
        const selectedIds = Array.from(checkboxes).map(cb => cb.value);
        const formData = new FormData();
        selectedIds.forEach(id => formData.append('genres', id));
        
        showIndicator('Guardando...', '#333');
        
        fetch('{{ url_for("preferences.update_preferences") }}', { 
            method: 'POST', body: formData, headers: {'X-Requested-With': 'XMLHttpRequest'}
        })
        .then(res => res.json())
        .then(data => showIndicator('¡Gustos Guardados!', '#28a745', 2000))
        .catch(err => showIndicator('Error al guardar', '#dc3545', 3000));
    }

    // BORRAR GÉNERO
    function deleteGenre(event, id, name) {
        event.preventDefault(); 
        if(!confirm(`¿Eliminar "${name}" permanentemente?`)) return;

        showIndicator('Eliminando...', '#dc3545');

        fetch(`/preferences/delete_genre/${id}`, { method: 'POST' })
        .then(res => res.json())
        .then(data => {
            if(data.success) {
                const btn = event.target.closest('button');
                const container = btn.closest('div'); 
                container.style.transition = "opacity 0.3s";
                container.style.opacity = '0';
                setTimeout(() => container.remove(), 300);
                showIndicator('Eliminado', '#28a745', 2000);
            } else {
                alert('Error al eliminar');
            }
        });
    }

    function showIndicator(text, color, hideTime = 0) {
        const el = document.getElementById('savingIndicator');
        el.innerHTML = text; el.style.background = color; el.style.color = '#fff'; el.style.display = 'block';
        if(hideTime > 0) setTimeout(() => { el.style.display = 'none'; }, hideTime);
    }
</script>

{% endblock %}