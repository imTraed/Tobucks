{% extends 'base.html' %}

{% block title %}Mis Gustos - Tobucks{% endblock %}

{% block head %}
<style>
  /* --- ESTÉTICA GENERAL --- */
  body { background-color: #050505; }

  .section-title {
    font-size: 0.9rem;
    letter-spacing: 2px;
    text-transform: uppercase;
    color: rgba(255, 255, 255, 0.5);
    margin-bottom: 1rem;
    text-align: center;
  }

  /* --- CHIPS DE GÉNEROS --- */
  .genre-checkbox { display: none; }

  .genre-chip-label {
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 12px 25px;
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 50px;
    color: rgba(255, 255, 255, 0.7);
    font-weight: 600;
    letter-spacing: 0.5px;
    cursor: pointer;
    transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    user-select: none;
    font-size: 0.9rem;
  }

  
  .chip-icon { 
    margin-right: 10px; 
    font-size: 1.1rem; 
    transition: transform 0.2s;
  }

  .genre-chip-label:hover {
    background: rgba(255, 255, 255, 0.15);
    border-color: rgba(255, 255, 255, 0.3);
    color: white;
    transform: translateY(-2px);
  }

  /* --- ESTADO: SELECCIONADO (AMARILLO) --- */
  .genre-checkbox:checked + .genre-chip-label {
    background: #FFD700;
    border-color: #FFD700;
    color: #000;
    box-shadow: 0 0 20px rgba(255, 215, 0, 0.4);
    transform: scale(1.05);
    font-weight: 800;
  }
  
  .genre-checkbox:checked + .genre-chip-label .chip-icon {
    transform: rotate(-10deg) scale(1.2);
  }

  /* BOTÓN DE GUARDAR */
  .btn-save-profile {
    background: linear-gradient(45deg, #FFD700, #FFC107);
    border: none;
    color: #000;
    font-weight: 800;
    letter-spacing: 1px;
    padding: 15px 50px;
    border-radius: 50px;
    box-shadow: 0 4px 15px rgba(255, 215, 0, 0.2);
    transition: all 0.3s;
    text-transform: uppercase;
  }
  
  .btn-save-profile:hover {
    transform: translateY(-3px);
    box-shadow: 0 10px 25px rgba(255, 215, 0, 0.4);
  }
  
  .btn-clear-all {
    color: #dc3545;
    border: 1px solid rgba(220, 53, 69, 0.3);
    background: transparent;
    border-radius: 50px;
    padding: 5px 15px;
    font-size: 0.8rem;
    transition: all 0.2s;
  }
  .btn-clear-all:hover {
    background: rgba(220, 53, 69, 0.1);
    border-color: #dc3545;
  }
</style>
{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            
            <div class="mb-5 text-center">
                <h6 class="text-warning text-uppercase small mb-2" style="letter-spacing: 3px;">Personalización</h6>
                <h1 class="display-4 fw-bold text-white mb-3">¿Qué te gusta ver?</h1>
                <p class="text-white-50 lead">
                    Selecciona tus géneros favoritos para que nuestra IA afine tus recomendaciones.
                </p>
            </div>

            <form id="preferencesForm">
                
                <div class="d-flex justify-content-end mb-3 px-2">
                    <button type="button" class="btn-clear-all" onclick="clearAllGenres()">
                        <i class="bi bi-trash3 me-1"></i> Quitar todos
                    </button>
                </div>

                <div class="d-flex flex-wrap gap-3 justify-content-center mb-5">
                    {% for genre in genres %}
                    
                    {% set icon = 'bi-film' %}
                    {% if 'Action' in genre.name or 'Acción' in genre.name %}{% set icon = 'bi-fire' %}
                    {% elif 'Adventure' in genre.name or 'Aventura' in genre.name %}{% set icon = 'bi-compass' %}
                    {% elif 'Animation' in genre.name or 'Animación' in genre.name %}{% set icon = 'bi-magic' %}
                    {% elif 'Comedy' in genre.name or 'Comedia' in genre.name %}{% set icon = 'bi-emoji-laughing' %}
                    {% elif 'Crime' in genre.name or 'Crimen' in genre.name %}{% set icon = 'bi-fingerprint' %}
                    {% elif 'Documentary' in genre.name or 'Documental' in genre.name %}{% set icon = 'bi-camera-reels' %}
                    {% elif 'Drama' in genre.name %}{% set icon = 'bi-masks-theater' %}
                    {% elif 'Family' in genre.name or 'Familia' in genre.name %}{% set icon = 'bi-house-heart' %}
                    {% elif 'Fantasy' in genre.name or 'Fantasía' in genre.name %}{% set icon = 'bi-stars' %}
                    {% elif 'History' in genre.name or 'Historia' in genre.name %}{% set icon = 'bi-hourglass-split' %}
                    {% elif 'Horror' in genre.name or 'Terror' in genre.name %}{% set icon = 'bi-ghost' %}
                    {% elif 'Music' in genre.name or 'Música' in genre.name %}{% set icon = 'bi-music-note-beamed' %}
                    {% elif 'Mystery' in genre.name or 'Misterio' in genre.name %}{% set icon = 'bi-search' %}
                    {% elif 'Romance' in genre.name %}{% set icon = 'bi-heart-fill' %}
                    {% elif 'Sci-Fi' in genre.name or 'Ciencia' in genre.name %}{% set icon = 'bi-rocket-takeoff' %}
                    {% elif 'Sport' in genre.name or 'Deporte' in genre.name %}{% set icon = 'bi-trophy' %}
                    {% elif 'Thriller' in genre.name or 'Suspenso' in genre.name %}{% set icon = 'bi-eye' %}
                    {% elif 'War' in genre.name or 'Guerra' in genre.name %}{% set icon = 'bi-shield-shaded' %}
                    {% elif 'Western' in genre.name %}{% set icon = 'bi-star' %}
                    {% endif %}

                    <div class="genre-item">
                        <input type="checkbox" 
                               class="genre-checkbox" 
                               id="genre_{{ genre.id }}" 
                               name="genres" 
                               value="{{ genre.id }}"
                               {% if user_genre_ids and genre.id in user_genre_ids %}checked{% endif %}>
                        
                        <label class="genre-chip-label" for="genre_{{ genre.id }}">
                            <i class="bi {{ icon }} chip-icon"></i>
                            {{ genre.name }}
                        </label>
                    </div>
                    {% endfor %}
                </div>

                <div class="d-flex justify-content-center gap-3">
                    <a href="{{ url_for('main.index') }}" class="btn btn-outline-light btn-lg px-4 rounded-pill" style="border-color: rgba(255,255,255,0.2);">
                        Volver
                    </a>
                    <button type="button" class="btn btn-save-profile" onclick="savePreferences()">
                        Guardar Mis Gustos
                    </button>
                </div>

            </form>
        </div>
    </div>
</div>

<script>
    // --- GUARDADO MANUAL CON BOTÓN ---
    
    document.addEventListener('DOMContentLoaded', function() {
        // Prevenir que el formulario tradicional se envíe
        document.getElementById('preferencesForm').addEventListener('submit', function(e) {
            e.preventDefault();
            savePreferences();
        });
    });

    function savePreferences() {
        // Obtener los IDs de los géneros seleccionados
        const checkboxes = document.querySelectorAll('.genre-checkbox:checked');
        const selectedIds = Array.from(checkboxes).map(cb => cb.value);
        
        // Crear FormData para enviar por AJAX
        const formData = new FormData();
        selectedIds.forEach(id => {
            formData.append('genres', id);
        });
        
        // Mostrar un indicador visual de que se está guardando
        showSavingIndicator(true);
        
        // Enviar la solicitud AJAX
        fetch('{{ url_for("users.preferences") }}', {
            method: 'POST',
            body: formData
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Error al guardar preferencias');
            }
            return response.json();
        })
        .then(data => {
            // Mostrar éxito
            showSavingIndicator(false, true);
            console.log('✓ Preferencias guardadas correctamente');
        })
        .catch(error => {
            // Mostrar error
            showSavingIndicator(false, false);
            console.error('✗ Error al guardar:', error);
        });
    }

    function showSavingIndicator(isSaving, isSuccess = null) {
        let indicator = document.getElementById('savingIndicator');
        
        // Crear el indicador si no existe
        if (!indicator) {
            indicator = document.createElement('div');
            indicator.id = 'savingIndicator';
            indicator.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 12px 20px;
                border-radius: 8px;
                font-weight: 600;
                z-index: 9999;
                display: none;
            `;
            document.body.appendChild(indicator);
        }
        
        if (isSaving) {
            indicator.textContent = '⏳ Guardando...';
            indicator.style.background = '#FFC107';
            indicator.style.color = '#000';
            indicator.style.display = 'block';
        } else if (isSuccess) {
            indicator.textContent = '✓ Guardado';
            indicator.style.background = '#28a745';
            indicator.style.color = 'white';
            indicator.style.display = 'block';
            setTimeout(() => {
                indicator.style.display = 'none';
            }, 2000);
        } else {
            indicator.textContent = '✗ Error al guardar';
            indicator.style.background = '#dc3545';
            indicator.style.color = 'white';
            indicator.style.display = 'block';
            setTimeout(() => {
                indicator.style.display = 'none';
            }, 3000);
        }
    }

    // Botón "Quitar todos"
    function clearAllGenres() {
        const checkboxes = document.querySelectorAll('.genre-checkbox');
        checkboxes.forEach(cb => cb.checked = false);
    }
</script>
{% endblock %}