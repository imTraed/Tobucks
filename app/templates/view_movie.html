{% extends 'base.html' %}

{% block title %}{{ movie.title }} - Tobucks{% endblock %}

{% block head %}
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <style>
    /* --- COLORES PERSONALIZADOS --- */
    :root {
      --gold-color: #FFD700;
    }

    /* --- FONDO INMERSIVO --- */
    body, html {
        height: 100%;
        margin: 0;
        padding: 0;
        background-color: #000;
    }

    /* Imagen de fondo fija (Blur) */
    .fixed-backdrop-image {
      position: fixed;
      top: 0; left: 0; width: 100vw; height: 100vh;
      background-size: cover;
      background-position: center;
      filter: blur(30px) brightness(0.4); /* Un poco más oscuro para leer mejor */
      z-index: -2;
      transform: scale(1.1);
    }

    /* Capa oscura fija (Vignette) */
    .fixed-backdrop-overlay {
      position: fixed;
      top: 0; left: 0; width: 100vw; height: 100vh;
      background: linear-gradient(to bottom, rgba(0,0,0,0.6) 0%, rgba(0,0,0,0.9) 100%);
      z-index: -1;
    }

    /* --- CONTENEDOR PRINCIPAL --- */
    .content-container {
        position: relative;
        z-index: 1;
        min-height: 100vh;
        display: flex;
        flex-direction: column;
        justify-content: center;
        padding: 4rem 2rem;
    }

    /* --- ADAPTACIÓN MÓVIL (CRÍTICO) --- */
    @media (max-width: 991px) {
        .content-container {
            /* Colchón superior para librar el Navbar y el Logo */
            padding-top: 25px; 
            /* Colchón inferior para librar la Bottom Bar */
            padding-bottom: 120px;
            padding-left: 20px;
            padding-right: 20px;
            justify-content: flex-start; /* Empezar desde arriba */
        }

        /* Centrar textos en móvil */
        .movie-details-col {
            text-align: center;
            padding-left: 0 !important; /* Quitar padding izquierdo de desktop */
        }

        /* Ajustar título gigante */
        .display-3 {
            font-size: 2.2rem !important;
            margin-bottom: 15px !important;
        }

        /* Centrar filas de iconos/badges */
        .meta-row {
            justify-content: center !important;
            margin-bottom: 20px !important;
        }
        
        .genres-wrapper {
            justify-content: center !important;
            margin-left: 0 !important;
            margin-top: 10px;
            width: 100%;
        }

        /* Póster más pequeño y centrado */
        .poster-frame img {
            max-height: 400px !important;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5) !important;
        }

        /* Botones anchos fáciles de tocar */
        .btn-action-mobile {
            width: 100%;
            max-width: 400px;
            margin: 0 auto 10px auto;
            display: flex; /* Para centrar contenido */
        }
    }

    /* --- ESTILOS GENERALES --- */
    .text-gold { color: var(--gold-color) !important; }
    .border-gold { border-color: var(--gold-color) !important; }
    .text-shadow-lg { text-shadow: 0 4px 15px rgba(0,0,0,0.8); }

    /* --- BOTONES --- */
    .btn-gold {
      background-color: var(--gold-color);
      color: #000;
      border: 2px solid var(--gold-color);
      font-weight: 800;
      letter-spacing: 1px;
      transition: all 0.3s ease;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }
    
    .btn-gold:hover {
      background-color: #ffe066;
      border-color: #ffe066;
      transform: translateY(-3px);
      box-shadow: 0 10px 25px rgba(255, 215, 0, 0.3);
    }

    .btn-outline-gold {
      background-color: transparent;
      color: var(--gold-color);
      border: 2px solid var(--gold-color);
      font-weight: 800;
      letter-spacing: 1px;
      transition: all 0.3s ease;
    }

    .btn-outline-gold:hover {
      background-color: var(--gold-color);
      color: #000;
      box-shadow: 0 0 15px rgba(255, 215, 0, 0.4);
    }
    
    /* --- PÓSTER --- */
    .poster-frame img {
      box-shadow: 0 20px 50px rgba(0,0,0,0.8);
      transition: transform 0.5s;
    }
    .poster-frame img:hover {
      transform: scale(1.02);
    }

    /* --- TRAILER --- */
    .trailer-wrapper {
        border-radius: 16px;
        overflow: hidden;
        border: 1px solid rgba(255, 255, 255, 0.1);
        background: #000;
        box-shadow: 0 15px 40px rgba(0, 0, 0, 0.6);
        transition: all 0.3s ease;
        margin-bottom: 2rem;
    }

    .trailer-wrapper:hover {
        border-color: var(--gold-color);
        transform: translateY(-2px);
    }

    .hover-text-gold:hover { color: var(--gold-color) !important; }
    .transition-base { transition: all 0.3s ease; }
  </style>
{% endblock %}

{% block content %}

<div class="fixed-backdrop-image"
    style="background-image: url('{% if movie.poster %}{{ url_for('static', filename=movie.poster) }}{% else %}{{ url_for('static', filename='img/default-movie.png') }}{% endif %}');">
</div>
<div class="fixed-backdrop-overlay"></div>

<div class="content-container container-fluid">
  <div class="row justify-content-center">
    <div class="col-xl-10">
      
      <a href="{{ url_for('movies.list_movies') }}" 
        onclick="history.back(); return false;" 
        class="text-white text-decoration-none mb-4 d-inline-flex align-items-center hover-text-gold transition-base">
        <i class="bi bi-arrow-left fs-4 me-2"></i>
        <span class="fs-6 fw-bold text-uppercase" style="letter-spacing: 1px;">Volver</span>
      </a>

      <div class="row align-items-start align-items-lg-center">
        
        <div class="col-md-5 col-lg-4 mb-4 mb-md-0 text-center">
          <div class="poster-frame">
            {% if movie.poster %}
              <img src="{{ url_for('static', filename=movie.poster) }}" alt="{{ movie.title }}" class="img-fluid rounded-4" style="max-height: 600px; width: auto;">
            {% else %}
              <div class="d-flex align-items-center justify-content-center bg-dark text-white-50 rounded-4 border border-secondary mx-auto" style="height: 450px; width: 300px; max-width: 100%;">
                <div class="text-center">
                  <i class="bi bi-film fs-1 mb-3 d-block"></i>
                  <span class="fw-bold">SIN PORTADA</span>
                </div>
              </div>
            {% endif %}
          </div>
        </div>

        <div class="col-md-7 col-lg-8 text-white ps-md-5 movie-details-col">
          
          <h1 class="display-3 fw-bolder mb-3 text-shadow-lg">{{ movie.title }}</h1>
          
          <div class="d-flex flex-wrap gap-3 mb-4 align-items-center meta-row">
            
            <div class="d-flex align-items-center text-gold fs-5" title="Puntuación: {{ movie.rating }}/10">
                {% set rating = movie.rating if movie.rating else 0 %}
                {% set stars = (rating / 2) | round | int %}
                {% for i in range(5) %}
                    {% if i < stars %} <i class="bi bi-star-fill"></i>
                    {% else %} <i class="bi bi-star text-white-50"></i>
                    {% endif %}
                {% endfor %}
                <span class="ms-2 fw-bold text-white small">{{ rating }}/10</span>
            </div>

            {% if movie.year and movie.year > 0 %}
            <div class="d-flex align-items-center text-white-50 ps-3 border-start border-secondary" style="height: 20px;">
                <i class="bi bi-calendar3 me-2 text-warning"></i>
                <span class="fw-bold small">{{ movie.year }}</span>
            </div>
            {% endif %}

            {% if movie.runtime and movie.runtime != 'N/A' %}
            <div class="d-flex align-items-center text-white-50 ps-3 border-start border-secondary" style="height: 20px;">
                <i class="bi bi-clock me-2 text-warning"></i>
                <span class="fw-bold small">{{ movie.runtime }}</span>
            </div>
            {% endif %}
             
            <div class="d-flex flex-wrap gap-2 ms-auto genres-wrapper">
              {% for genre in movie.genres %}
                <span class="badge bg-transparent border border-gold text-gold rounded-pill px-3 py-2 fw-bold text-uppercase" style="letter-spacing: 0.5px; font-size: 0.7rem;">
                  {{ genre.name }}
                </span>
              {% endfor %}
            </div>
          </div>

          {% if current_user.is_authenticated %}
          <div class="mb-5">
              {% set is_seen = movie in current_user.seen_list %}
              <button onclick="toggleSeen('{{ movie.id }}', this)" 
                      class="btn {% if is_seen %}btn-gold{% else %}btn-outline-gold{% endif %} rounded-pill px-4 py-3 text-uppercase d-inline-flex align-items-center gap-2 btn-action-mobile">
                  {% if is_seen %}
                      <i class="bi bi-check-circle-fill"></i> <span>Vista</span>
                  {% else %}
                      <i class="bi bi-eye"></i> <span>Marcar como vista</span>
                  {% endif %}
              </button>
          </div>
          {% endif %}

          <div class="mb-4 pe-lg-5">
            <h5 class="fw-bold text-gold text-uppercase mb-2 small ls-1">Sinopsis</h5>
            <p class="lead fs-5 text-white opacity-75" style="line-height: 1.6; font-weight: 300;">
              {{ movie.description or "No hay descripción disponible para esta película." }}
            </p>
          </div>

          <div class="mb-5 pe-lg-5">
            <h5 class="fw-bold text-gold text-uppercase mb-3 small ls-1">
                <i class="bi bi-play-circle-fill me-2"></i>Trailer
            </h5>

            {% if movie.embed_url %}
                <div class="trailer-wrapper">
                    <div class="ratio ratio-16x9">
                        <iframe src="{{ movie.embed_url }}" title="Trailer" frameborder="0" allowfullscreen></iframe>
                    </div>
                </div>
            {% else %}
                <div class="alert alert-dark border-secondary d-flex flex-column flex-md-row align-items-center text-white-50 p-3 rounded-4">
                    <div class="mb-3 mb-md-0 text-center text-md-start">
                        <span class="d-block fw-bold text-white"><i class="bi bi-youtube me-2 text-danger"></i>Trailer no disponible</span>
                    </div>
                    <a href="https://www.youtube.com/results?search_query=trailer+{{ movie.title }}" target="_blank" class="btn btn-outline-light btn-sm ms-md-auto rounded-pill">
                        Buscar en YouTube
                    </a>
                </div>
            {% endif %}
          </div>

          {% if current_user.is_admin %}
            <div class="pt-4 border-top border-secondary border-opacity-25">
              <p class="text-uppercase small fw-bold text-white-50 mb-3">Zona Admin</p>
              <div class="d-flex flex-wrap gap-3 justify-content-center justify-content-md-start">
                <a href="{{ url_for('movies.edit_movie', movie_id=movie.id) }}" class="btn btn-dark border-secondary btn-sm px-4 py-2 rounded-pill d-flex align-items-center">
                  <i class="bi bi-pencil-fill me-2"></i> Editar
                </a>
                <form action="{{ url_for('movies.delete_movie', movie_id=movie.id) }}" method="post" class="d-inline">
                  <button type="submit" class="btn btn-danger btn-sm px-4 py-2 rounded-pill d-flex align-items-center" onclick="return confirm('¿Eliminar permanentemente?');">
                    <i class="bi bi-trash-fill me-2"></i> Eliminar
                  </button>
                </form>
              </div>
            </div>
          {% endif %}

        </div>
      </div>
    </div>
  </div>
</div>

<script>
    async function toggleSeen(movieId, btn) {
        try {
            btn.disabled = true;
            // Animación visual inmediata
            btn.style.opacity = '0.7';
            
            const response = await fetch(`/movies/toggle_seen/${movieId}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            });
            
            const data = await response.json();
            
            if (data.success) {
                if (data.status === 'seen') {
                    btn.className = 'btn btn-gold rounded-pill px-4 py-3 text-uppercase d-inline-flex align-items-center gap-2 btn-action-mobile';
                    btn.innerHTML = '<i class="bi bi-check-circle-fill"></i> <span>Vista</span>';
                } else {
                    btn.className = 'btn btn-outline-gold rounded-pill px-4 py-3 text-uppercase d-inline-flex align-items-center gap-2 btn-action-mobile';
                    btn.innerHTML = '<i class="bi bi-eye"></i> <span>Marcar como vista</span>';
                }
            }
        } catch (error) {
            console.error('Error:', error);
        } finally {
            btn.disabled = false;
            btn.style.opacity = '1';
        }
    }
</script>

{% endblock %}